<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>图片懒加载踩坑 | 正经博客</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="陈俊生的正经博客">
    
    <link rel="preload" href="/assets/css/0.styles.985c0261.css" as="style"><link rel="preload" href="/assets/js/app.efdf1017.js" as="script"><link rel="preload" href="/assets/js/2.d444b0a2.js" as="script"><link rel="preload" href="/assets/js/1.7ca1e89d.js" as="script"><link rel="preload" href="/assets/js/24.bb5e2239.js" as="script"><link rel="prefetch" href="/assets/js/10.1a004c10.js"><link rel="prefetch" href="/assets/js/11.6560bed7.js"><link rel="prefetch" href="/assets/js/12.20398b1f.js"><link rel="prefetch" href="/assets/js/13.6f95ee0c.js"><link rel="prefetch" href="/assets/js/14.782f19f1.js"><link rel="prefetch" href="/assets/js/15.d25bd3fe.js"><link rel="prefetch" href="/assets/js/16.97c2c4a8.js"><link rel="prefetch" href="/assets/js/17.895b550f.js"><link rel="prefetch" href="/assets/js/18.cdc68d17.js"><link rel="prefetch" href="/assets/js/19.ef8e3a48.js"><link rel="prefetch" href="/assets/js/20.b5d8c482.js"><link rel="prefetch" href="/assets/js/21.2980ee98.js"><link rel="prefetch" href="/assets/js/22.b16736cf.js"><link rel="prefetch" href="/assets/js/23.221060a2.js"><link rel="prefetch" href="/assets/js/25.65cbc6a7.js"><link rel="prefetch" href="/assets/js/26.ee90196a.js"><link rel="prefetch" href="/assets/js/27.101bf521.js"><link rel="prefetch" href="/assets/js/28.35ac7c38.js"><link rel="prefetch" href="/assets/js/29.aacd3977.js"><link rel="prefetch" href="/assets/js/3.5ff63961.js"><link rel="prefetch" href="/assets/js/30.68a43ff9.js"><link rel="prefetch" href="/assets/js/31.cc9a91ad.js"><link rel="prefetch" href="/assets/js/32.12ebb196.js"><link rel="prefetch" href="/assets/js/33.a4383cda.js"><link rel="prefetch" href="/assets/js/34.bfa72010.js"><link rel="prefetch" href="/assets/js/35.aeb2002f.js"><link rel="prefetch" href="/assets/js/36.0a918e07.js"><link rel="prefetch" href="/assets/js/37.e00295cb.js"><link rel="prefetch" href="/assets/js/38.da376bbb.js"><link rel="prefetch" href="/assets/js/39.2f9ba8d7.js"><link rel="prefetch" href="/assets/js/4.86934754.js"><link rel="prefetch" href="/assets/js/40.86d171b4.js"><link rel="prefetch" href="/assets/js/41.f1a79136.js"><link rel="prefetch" href="/assets/js/42.f7b4a720.js"><link rel="prefetch" href="/assets/js/43.b824f47f.js"><link rel="prefetch" href="/assets/js/44.b54f4a3e.js"><link rel="prefetch" href="/assets/js/45.2aae7666.js"><link rel="prefetch" href="/assets/js/46.185897cf.js"><link rel="prefetch" href="/assets/js/47.b5418ff9.js"><link rel="prefetch" href="/assets/js/48.099d6193.js"><link rel="prefetch" href="/assets/js/49.18417fbf.js"><link rel="prefetch" href="/assets/js/5.ed646e61.js"><link rel="prefetch" href="/assets/js/50.852f955c.js"><link rel="prefetch" href="/assets/js/51.b571fc7f.js"><link rel="prefetch" href="/assets/js/52.05037053.js"><link rel="prefetch" href="/assets/js/53.69bf0a82.js"><link rel="prefetch" href="/assets/js/54.9449705b.js"><link rel="prefetch" href="/assets/js/55.899be268.js"><link rel="prefetch" href="/assets/js/56.b40737e3.js"><link rel="prefetch" href="/assets/js/57.4e74d18a.js"><link rel="prefetch" href="/assets/js/58.4ba1d249.js"><link rel="prefetch" href="/assets/js/59.9a911d76.js"><link rel="prefetch" href="/assets/js/6.b1c318f0.js"><link rel="prefetch" href="/assets/js/60.cc0e0926.js"><link rel="prefetch" href="/assets/js/61.24ba53e0.js"><link rel="prefetch" href="/assets/js/62.6ff74996.js"><link rel="prefetch" href="/assets/js/63.d31d2aac.js"><link rel="prefetch" href="/assets/js/64.d14c4015.js"><link rel="prefetch" href="/assets/js/65.124611bc.js"><link rel="prefetch" href="/assets/js/66.da3bf42d.js"><link rel="prefetch" href="/assets/js/67.e17449ef.js"><link rel="prefetch" href="/assets/js/68.ce06c506.js"><link rel="prefetch" href="/assets/js/69.dbda80ad.js"><link rel="prefetch" href="/assets/js/7.f368e4d8.js"><link rel="prefetch" href="/assets/js/70.33b15820.js"><link rel="prefetch" href="/assets/js/71.c74741b4.js"><link rel="prefetch" href="/assets/js/72.b5e33ea4.js"><link rel="prefetch" href="/assets/js/73.5d09bd2e.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.12181bb4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.985c0261.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">正经博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/aboutme.html" class="nav-link">
  About Me
</a></div> <a href="https://github.com/hentaicracker/new-blog/tree/vuepress" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/aboutme.html" class="nav-link">
  About Me
</a></div> <a href="https://github.com/hentaicracker/new-blog/tree/vuepress" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>2025</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/2025/zongjie.html" class="sidebar-link">2024 &amp; 2025</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>2024</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/2024/jietu.html" class="sidebar-link">长截图生成实践</a></li><li><a href="/2024/zongjie.html" class="sidebar-link">2023 &amp; 2024</a></li><li><a href="/2024/chengzhang.html" class="sidebar-link">工程师的自我修养</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>2023</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/2023/suibi.html" class="sidebar-link">路遥远，我们一起走</a></li><li><a href="/2023/rust-1.html" class="sidebar-link">《Rust 程序设计语言》读书笔记</a></li><li><a href="/2023/docker.html" class="sidebar-link">使用 Docker 搭建开发环境</a></li><li><a href="/2023/zongjie.html" class="sidebar-link">Do not be afraid</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>2022</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/2022/skia.html" class="sidebar-link">使用 Skia 绘制 2D 图形</a></li><li><a href="/2022/mf.html" class="sidebar-link">基于 MF 的组件化共享工作流 - Qcon 广州演讲整理</a></li><li><a href="/2022/zongjie.html" class="sidebar-link">2021 年终总结</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>2021</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/2021/docker-osx.html" class="sidebar-link">使用 docker-osx 搭建 macos 构建环境</a></li><li><a href="/2021/zongjie.html" class="sidebar-link">工作 5 年</a></li><li><a href="/2021/deco.html" class="sidebar-link">解构 Deco 编辑器</a></li><li><a href="/2021/py.html" class="sidebar-link">面向前端工程师的 Python 快速入门（30min）</a></li><li><a href="/2021/ts.html" class="sidebar-link">TypeScript 类型编程</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>2020</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/2020/deco.html" class="sidebar-link">Deco 图层处理层简明介绍</a></li><li><a href="/2020/rAF.html" class="sidebar-link">requestAnimationFrame 执行机制探索</a></li><li><a href="/2020/aopioc.html" class="sidebar-link">Nodejs AOP 与 IOC 实践</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>2019</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/2019/hooks.html" class="sidebar-link">使用 React Hooks + Context 打造简版 Redux</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>2018</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/2018/lazyload.html" aria-current="page" class="active sidebar-link">图片懒加载踩坑</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/2018/lazyload.html#原理" class="sidebar-link">原理</a></li><li class="sidebar-sub-header"><a href="/2018/lazyload.html#实现" class="sidebar-link">实现</a></li></ul></li><li><a href="/2018/protocol.html" class="sidebar-link">互联网协议梳理</a></li><li><a href="/2018/authenticate.html" class="sidebar-link">用户认证流程梳理</a></li><li><a href="/2018/http.html" class="sidebar-link">HTTP 详细</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>2017</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/2017/2017-08-06.html" class="sidebar-link">《硅谷钢铁侠——马斯克的冒险人生》读书笔记</a></li><li><a href="/2017/jsTips.html" class="sidebar-link">JavaScript Tips</a></li><li><a href="/2017/regexp.html" class="sidebar-link">正则表达式 cheatsheet &amp; 实例</a></li><li><a href="/2017/string.html" class="sidebar-link">String 踩坑</a></li><li><a href="/2017/ydkjs-1.html" class="sidebar-link">《You don't know JavaScirpt》</a></li><li><a href="/2017/2017-03-12.html" class="sidebar-link">《人类简史》读书笔记</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>2016</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/2016/2016-12-31.html" class="sidebar-link">2016 &amp; 2017</a></li><li><a href="/2016/2016-11-16.html" class="sidebar-link">《围城》读书笔记</a></li><li><a href="/2016/2016-10-29.html" class="sidebar-link">《血色浪漫》读书笔记</a></li><li><a href="/2016/2016-09-21.html" class="sidebar-link">这段时间的感受与见闻</a></li><li><a href="/2016/hello-world.html" class="sidebar-link">《乔布斯传》读书笔记</a></li><li><a href="/2016/liqi.html" class="sidebar-link">我是荒野大镖客，这是我的利器</a></li><li><a href="/2016/2016-04-23.html" class="sidebar-link">学习日常</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="原理"><a href="#原理" class="header-anchor">#</a> 原理</h2> <p>对网页加载速度影响最大的就是图片，一张普通的图片可能会有好几 M 的大小，当图片很多时，网页的加载速度变得很缓慢。</p> <p>为了优化网页性能以及用户体验，我们对图片进行<code>懒加载</code>。</p> <p>懒加载是一种对网页性能优化的方式，它的原理是优先加载在可视区域内的图片，而不一次性加载所有图片。当浏览器滚动，图片进入可视区时再去加载图片。通过设置图片的 <code>src</code> 属性来让浏览器发起图片的请求。当这个属性为空或者没有时，就不会发送请求。</p> <h2 id="实现"><a href="#实现" class="header-anchor">#</a> 实现</h2> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>此文所涉及的懒加载皆是在垂直方向上的滚动加载，横向滚动暂不考虑。</p></div> <p>懒加载的实现主要是判断当前图片是否到了可视区域这一核心逻辑。我们先来整理一下实现思路：</p> <ol><li>拿到所有的图片 <code>img dom</code> 。</li> <li>遍历每个图片判断当前图片是否到了可视区范围内。</li> <li>如果到了就设置图片的 src 属性。</li> <li>绑定 window 的 <code>scroll</code> 事件，对其进行事件监听。</li></ol> <h4 id="html-结构"><a href="#html-结构" class="header-anchor">#</a> HTML 结构</h4> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>img-area<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>first<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./img/ceng.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>img-area<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./img/data.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>img-area<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./img/huaji.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>img-area<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./img/liqi1.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>img-area<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./img/liqi2.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>img-area<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./img/steve-jobs.jpg<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>此时 img 标签是没有 src 属性的，我们把真实的图片地址放在一个属性里，这里我们使用 HTML5 的 <code>data</code> 属性，将真实地址放在自定义的 <code>data-src</code> 中。</p> <h4 id="判断图片是否进入了可视区域"><a href="#判断图片是否进入了可视区域" class="header-anchor">#</a> 判断图片是否进入了可视区域</h4> <p>这一逻辑有两种方法，听我娓娓道来。</p> <p><strong>方法一</strong></p> <p>第一种方法我们通过计算该图片距离 <code>document</code> 顶部的高度是否小于当前可视区域相对于 document 顶部高度来判断。</p> <p>可视区域相对于 document 顶部高度的计算方法：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> clientHeight <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>clientHeight<span class="token punctuation">;</span> <span class="token comment">// 视口高度，也就是窗口的高度。</span>
<span class="token keyword">const</span> scrollHeight <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>scrollTop <span class="token operator">+</span> clientHeight<span class="token punctuation">;</span> <span class="token comment">// 滚动条偏移文档顶部的高度（也就是文档从顶部开始到可视区域被抹去的高度） + 视口高度</span>
</code></pre></div><p>画了一张图方便理解：</p> <p><img src="/assets/img/height.f3a0e8b4.png" alt="高度"></p> <p>然后就是计算该图片距离文档顶部的高度。有两种方法，第一种方法是通过元素的 <code>offsetTop</code> 属性来计算。从上图我们了解到元素的 offsetTop 属性是相对于一个 <code>position</code> 为 <code>非 static</code> 的祖先元素，也就是 <code>child.offsetParent</code> 。同时需要将祖先元素的 <code>border</code> 考虑在内，我们通过<code>child.offsetParent.clientTop</code>可以拿到边框厚度。</p> <p>由此我们得到元素距离文档顶部的高度的计算方法：</p> <div class="language-javascript extra-class"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br></div><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">getTop</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> initVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> top <span class="token operator">=</span> el<span class="token punctuation">.</span>offsetTop <span class="token operator">+</span> initVal<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>offsetParent <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        top <span class="token operator">+=</span> el<span class="token punctuation">.</span>offsetParent<span class="token punctuation">.</span>clientTop<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">getTop</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>offsetParent<span class="token punctuation">,</span> top<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> top<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里的这个方法使用了 <code>尾递归调用</code> 。可以提高递归性能。当然这里也可以用循环来实现：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">getTop</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> top <span class="token operator">=</span> el<span class="token punctuation">.</span>offsetTop<span class="token punctuation">;</span>
    <span class="token keyword">var</span> parent <span class="token operator">=</span> el<span class="token punctuation">.</span>offsetParent<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>parent <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        top <span class="token operator">+=</span> parent<span class="token punctuation">.</span>offsetTop <span class="token operator">+</span> parent<span class="token punctuation">.</span>clientTop<span class="token punctuation">;</span>
        parent <span class="token operator">=</span> parent<span class="token punctuation">.</span>offsetParent<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> top<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>第二种方法是使用 <code>element.getBoundingClientRect()</code> API 直接得到 top 值。</p> <p>getBoundingClientRect 的返回值如下图：</p> <p><img src="data:image/jpeg;base64,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" alt="rect"></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> first  <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'first'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">getTop</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 130</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>first<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>top<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 130</span>
</code></pre></div><p>于是我们得到判断方法：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">inSight</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> clientHeight <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>clientHeight<span class="token punctuation">;</span>
    <span class="token keyword">const</span> scrollHeight <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>scrollTop <span class="token operator">+</span> clientHeight<span class="token punctuation">;</span>
    <span class="token comment">// 方法一</span>
    <span class="token keyword">return</span> <span class="token function">getTop</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> scrollHeight<span class="token punctuation">;</span>
    <span class="token comment">// 方法二</span>
    <span class="token comment">// return el.getBoundingClientRect().top &lt; clientHeight;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接下来就是对每个图片进行判断和赋值。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">loadImg</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>el<span class="token punctuation">.</span>src<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        el<span class="token punctuation">.</span>src <span class="token operator">=</span> el<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>src<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">checkImgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> imgs <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>imgs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">el</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">inSight</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">loadImg</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>最后给 window 绑定 <code>onscroll</code> 事件以及 <code>onload</code> 事件：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">,</span> checkImgs<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
window<span class="token punctuation">.</span>onload <span class="token operator">=</span> checkImgs<span class="token punctuation">;</span>
</code></pre></div><p>我们知道类似 <code>scroll</code> 或 <code>resize</code> 这样的事件浏览器可能在很短的时间内触发很多次，为了提高网页性能，我们需要一个<strong>节流</strong>函数来控制函数的多次触发，在一段时间内（如 500ms）只执行一次回调。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/**
 * 持续触发事件，每隔一段时间，只执行一次事件。
 * @param fun 要执行的函数
 * @param delay 延迟时间
 * @param time 在 time 时间内必须执行一次
 */</span>
<span class="token keyword">function</span> <span class="token function">throttle</span><span class="token punctuation">(</span><span class="token parameter">fun<span class="token punctuation">,</span> delay<span class="token punctuation">,</span> time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> timeout<span class="token punctuation">;</span>
    <span class="token keyword">var</span> previous <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> now <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> context <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> args <span class="token operator">=</span> arguments<span class="token punctuation">;</span>
        <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> previous <span class="token operator">&gt;=</span> time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">fun</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            previous <span class="token operator">=</span> now<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">fun</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">,</span> <span class="token function">throttle</span><span class="token punctuation">(</span>checkImgs<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>方法二</strong></p> <p>HTML5 有一个新的 <code>IntersectionObserver</code> API，它可以自动观察元素是否可见。</p> <p>主要用法：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntersectionObserver</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> option<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 开始观察</span>
observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'first'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 停止观察</span>
observer<span class="token punctuation">.</span><span class="token function">unobserve</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'first'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 关闭观察器</span>
observer<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>目标的可见性发生变化时就会调用观察器的 callback。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">changes</span><span class="token operator">:</span> IntersectionObserverEntry<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>changes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// IntersectionObserverEntry</span>
<span class="token punctuation">{</span>
    <span class="token literal-property property">time</span><span class="token operator">:</span> <span class="token number">29.499999713152647</span><span class="token punctuation">,</span>
    <span class="token literal-property property">intersectionRatio</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token literal-property property">boundingClientRect</span><span class="token operator">:</span> DOMRectReadOnly <span class="token punctuation">{</span>
        <span class="token literal-property property">bottom</span><span class="token operator">:</span> <span class="token number">144</span><span class="token punctuation">,</span>
        <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
        <span class="token literal-property property">left</span><span class="token operator">:</span> <span class="token number">289</span><span class="token punctuation">,</span>
        <span class="token literal-property property">right</span><span class="token operator">:</span> <span class="token number">293</span><span class="token punctuation">,</span>
        <span class="token literal-property property">top</span><span class="token operator">:</span> <span class="token number">140</span><span class="token punctuation">,</span>
        <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
        <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">289</span><span class="token punctuation">,</span>
        <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">140</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">intersectionRect</span><span class="token operator">:</span> DOMRectReadOnly<span class="token punctuation">,</span>
    <span class="token literal-property property">isIntersecting</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">rootBounds</span><span class="token operator">:</span> DOMRectReadOnly<span class="token punctuation">,</span>
    <span class="token literal-property property">target</span><span class="token operator">:</span> img#first
<span class="token punctuation">}</span>
</code></pre></div><p>详细释义：</p> <ul><li>time： 可见性发生变化的时间，是一个高精度时间戳，单位为毫秒</li> <li>intersectionRatio： 目标元素的可见比例，即 intersectionRect 占 boundingClientRect 的比例，完全可见时为 1 ，完全不可见时小于等于 0</li> <li>boundingClientRect： 目标元素的矩形区域的信息</li> <li>intersectionRect： 目标元素与视口（或根元素）的交叉区域的信息</li> <li>rootBounds： 根元素的矩形区域的信息，getBoundingClientRect() 方法的返回值，如果没有根元素（即直接相对于视口滚动），则返回 null</li> <li>isIntersecting： 是否进入了视口，boolean 值</li> <li>target： 被观察的目标元素，是一个 DOM 节点对象</li></ul> <p>使用 IntersectionObserver 实现图片懒加载：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token parameter">tag</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntersectionObserver</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token parameter">changes</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        changes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">change</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>change<span class="token punctuation">.</span>intersectionRatio <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">var</span> img <span class="token operator">=</span> change<span class="token punctuation">.</span>target<span class="token punctuation">;</span>
                img<span class="token punctuation">.</span>src <span class="token operator">=</span> img<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>src<span class="token punctuation">;</span>
                observer<span class="token punctuation">.</span><span class="token function">unobserve</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
<span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>完整代码见 <a href="https://github.com/hentaicracker/new-blog/blob/vuepress/source/lazyload.html" target="_blank" rel="noopener noreferrer">github<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>完 😃</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/2019/hooks.html" class="prev">
        使用 React Hooks + Context 打造简版 Redux
      </a></span> <span class="next"><a href="/2018/protocol.html">
        互联网协议梳理
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.efdf1017.js" defer></script><script src="/assets/js/2.d444b0a2.js" defer></script><script src="/assets/js/1.7ca1e89d.js" defer></script><script src="/assets/js/24.bb5e2239.js" defer></script>
  </body>
</html>
